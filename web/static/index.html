<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Test Generator â€” AutomaterSelenium</title>
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:        #0f1117;
      --surface:   #1a1d27;
      --surface2:  #21253a;
      --border:    #2e3348;
      --green:     #22c55e;
      --green-dim: #16a34a;
      --blue:      #3b82f6;
      --yellow:    #f59e0b;
      --red:       #ef4444;
      --text:      #e2e8f0;
      --text-dim:  #94a3b8;
      --radius:    10px;
      --font:      'Segoe UI', system-ui, sans-serif;
      --mono:      'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    }
    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font); font-size: 14px; }
    a { color: var(--blue); text-decoration: none; }
    a:hover { text-decoration: underline; }
    button { cursor: pointer; font-family: var(--font); }
    input, textarea, select { font-family: var(--font); font-size: 14px; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--surface); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; height: 56px; background: var(--surface);
      border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon { font-size: 22px; }
    .logo-text { font-size: 16px; font-weight: 600; }
    .logo-badge {
      background: var(--green); color: #000; font-size: 10px; font-weight: 700;
      padding: 2px 7px; border-radius: 20px; letter-spacing: .5px;
    }
    .header-right { display: flex; gap: 12px; align-items: center; }
    .btn-sm {
      padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border);
      background: var(--surface2); color: var(--text-dim); font-size: 13px;
      transition: .15s;
    }
    .btn-sm:hover { border-color: var(--blue); color: var(--blue); }

    .main-body {
      display: grid;
      grid-template-columns: 380px 1fr;
      grid-template-rows: 1fr auto;
      flex: 1; overflow: hidden;
    }

    /* â”€â”€ Left panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #left {
      grid-row: 1 / 3;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      overflow-y: auto; padding: 20px; gap: 18px;
    }

    .section-title {
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 1px; color: var(--text-dim); margin-bottom: 8px;
    }

    /* Drop zone */
    #drop-zone {
      border: 2px dashed var(--border); border-radius: var(--radius);
      padding: 28px 20px; text-align: center; cursor: pointer;
      transition: .2s; background: var(--surface2); position: relative;
    }
    #drop-zone:hover, #drop-zone.drag-over { border-color: var(--blue); background: rgba(59,130,246,.06); }
    #drop-zone.has-file { border-color: var(--green); background: rgba(34,197,94,.06); }
    #drop-zone .dz-icon { font-size: 32px; margin-bottom: 8px; }
    #drop-zone .dz-primary { font-size: 14px; font-weight: 500; }
    #drop-zone .dz-secondary { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
    #drop-zone .dz-filename {
      font-size: 13px; font-weight: 600; color: var(--green);
      margin-top: 8px; word-break: break-all;
    }
    #file-input { display: none; }
    #clear-file {
      position: absolute; top: 8px; right: 8px;
      background: none; border: none; color: var(--text-dim);
      font-size: 16px; line-height: 1; padding: 2px 6px;
      border-radius: 4px;
    }
    #clear-file:hover { color: var(--red); background: rgba(239,68,68,.1); }

    /* Divider */
    .or-divider {
      display: flex; align-items: center; gap: 10px; color: var(--text-dim); font-size: 12px;
    }
    .or-divider::before, .or-divider::after {
      content: ''; flex: 1; height: 1px; background: var(--border);
    }

    /* Textarea */
    textarea {
      width: 100%; padding: 10px 12px; border-radius: var(--radius);
      border: 1px solid var(--border); background: var(--surface2);
      color: var(--text); resize: vertical; min-height: 100px;
      line-height: 1.5; transition: .15s;
    }
    textarea:focus { outline: none; border-color: var(--blue); }
    textarea::placeholder { color: var(--text-dim); }

    /* Inputs */
    .field { display: flex; flex-direction: column; gap: 5px; }
    .field label { font-size: 12px; color: var(--text-dim); font-weight: 500; }
    input[type="text"] {
      width: 100%; padding: 8px 12px; border-radius: var(--radius);
      border: 1px solid var(--border); background: var(--surface2);
      color: var(--text); transition: .15s;
    }
    input[type="text"]:focus { outline: none; border-color: var(--blue); }
    input[type="text"]::placeholder { color: var(--text-dim); }
    select {
      width: 100%; padding: 8px 12px; border-radius: var(--radius);
      border: 1px solid var(--border); background: var(--surface2);
      color: var(--text); appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 12px center;
    }
    select:focus { outline: none; border-color: var(--blue); }

    /* Generate button */
    #btn-generate {
      width: 100%; padding: 12px;
      background: var(--green); color: #000;
      border: none; border-radius: var(--radius);
      font-size: 15px; font-weight: 700; letter-spacing: .3px;
      transition: .15s; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    #btn-generate:hover:not(:disabled) { background: var(--green-dim); }
    #btn-generate:disabled { opacity: .5; cursor: not-allowed; }
    #btn-generate .spinner {
      display: none; width: 16px; height: 16px;
      border: 2px solid #000; border-top-color: transparent;
      border-radius: 50%; animation: spin .7s linear infinite;
    }
    #btn-generate.loading .spinner { display: block; }
    #btn-generate.loading .btn-label { opacity: .6; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Right panel (log) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #right {
      display: flex; flex-direction: column;
      overflow: hidden; padding: 20px; gap: 14px;
    }

    .run-header {
      display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    }
    .run-title { font-size: 15px; font-weight: 600; }
    #status-badge {
      padding: 3px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
      letter-spacing: .4px; text-transform: uppercase;
    }
    .badge-idle    { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border); }
    .badge-queued  { background: rgba(245,158,11,.15); color: var(--yellow); border: 1px solid rgba(245,158,11,.3); }
    .badge-running { background: rgba(59,130,246,.15); color: var(--blue); border: 1px solid rgba(59,130,246,.3); animation: pulse 1.5s ease-in-out infinite; }
    .badge-success { background: rgba(34,197,94,.15); color: var(--green); border: 1px solid rgba(34,197,94,.3); }
    .badge-failed  { background: rgba(239,68,68,.15); color: var(--red); border: 1px solid rgba(239,68,68,.3); }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.65} }

    /* Log panel */
    #log-panel {
      flex: 1; overflow-y: auto;
      background: #0a0c14; border: 1px solid var(--border);
      border-radius: var(--radius); padding: 14px 16px;
      font-family: var(--mono); font-size: 12.5px; line-height: 1.7;
    }
    .log-empty { color: var(--text-dim); font-style: italic; }
    .log-line { white-space: pre-wrap; word-break: break-word; }
    .log-line.type-log   { color: #c9d1e0; }
    .log-line.type-error { color: var(--red); }
    .log-line.type-info  { color: var(--blue); }
    .log-line.type-ok    { color: var(--green); }

    /* Files panel */
    #files-panel { flex-shrink: 0; }
    #files-list {
      display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;
    }
    .file-chip {
      display: flex; align-items: center; gap: 6px;
      padding: 5px 12px; border-radius: 6px;
      background: var(--surface2); border: 1px solid var(--border);
      font-size: 12px; color: var(--text);
      transition: .15s;
    }
    .file-chip:hover { border-color: var(--green); color: var(--green); }
    .file-chip .fi { font-size: 14px; }
    #files-panel.hidden { display: none; }

    /* â”€â”€ Bottom â€” Run History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #history {
      border-top: 1px solid var(--border);
      background: var(--surface); padding: 12px 20px;
      overflow-x: auto; flex-shrink: 0; max-height: 200px; overflow-y: auto;
    }
    #history-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 8px;
    }
    #history-toggle { font-size: 12px; color: var(--text-dim); background: none; border: none; cursor: pointer; }
    #history-toggle:hover { color: var(--text); }
    #history-body.collapsed { display: none; }

    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left; font-size: 11px; font-weight: 600;
      text-transform: uppercase; letter-spacing: .8px; color: var(--text-dim);
      padding: 4px 8px; border-bottom: 1px solid var(--border);
    }
    td { padding: 5px 8px; font-size: 12px; border-bottom: 1px solid rgba(46,51,72,.5); }
    tr:hover td { background: rgba(255,255,255,.02); }
    tr.active-row td { background: rgba(59,130,246,.08); }
    .st { display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .st-queued  { background: rgba(245,158,11,.2); color: var(--yellow); }
    .st-running { background: rgba(59,130,246,.2); color: var(--blue); }
    .st-success { background: rgba(34,197,94,.2);  color: var(--green); }
    .st-failed  { background: rgba(239,68,68,.2);  color: var(--red);   }
    .st-idle    { background: var(--surface2);      color: var(--text-dim); }
    .tr-click { cursor: pointer; }

    /* â”€â”€ Notification toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed; bottom: 24px; right: 24px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px 18px; font-size: 13px;
      box-shadow: 0 8px 32px rgba(0,0,0,.4);
      transform: translateY(80px); opacity: 0; transition: .3s;
      pointer-events: none; max-width: 340px; z-index: 100;
    }
    #toast.show { transform: translateY(0); opacity: 1; }
    #toast.toast-ok  { border-color: var(--green); color: var(--green); }
    #toast.toast-err { border-color: var(--red);   color: var(--red);   }
  </style>
</head>
<body>
<div id="app">

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header>
    <div class="logo">
      <span class="logo-icon">ğŸ¤–</span>
      <span class="logo-text">AI Test Generator</span>
      <span class="logo-badge">AutomaterSelenium</span>
    </div>
    <div class="header-right">
      <button class="btn-sm" onclick="loadHistory()">âŸ³ Refresh History</button>
      <button class="btn-sm" onclick="clearLog()">ğŸ—‘ Clear Log</button>
    </div>
  </header>

  <!-- â”€â”€ Main body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="main-body">

    <!-- Left: input form -->
    <div id="left">
      <div>
        <div class="section-title">ğŸ“„ Document Upload</div>
        <div id="drop-zone" onclick="document.getElementById('file-input').click()"
             ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
          <button id="clear-file" onclick="clearFile(event)" title="Remove file" style="display:none">âœ•</button>
          <div class="dz-icon" id="dz-icon">ğŸ“‚</div>
          <div class="dz-primary" id="dz-primary">Drop a document here or click to browse</div>
          <div class="dz-secondary" id="dz-secondary">PDF Â· DOCX Â· XLSX Â· PPTX Â· TXT Â· MD</div>
          <div class="dz-filename" id="dz-filename"></div>
        </div>
        <input type="file" id="file-input" accept=".pdf,.docx,.xlsx,.xls,.pptx,.txt,.md"
               onchange="onFileSelected(event)" />
      </div>

      <div class="or-divider">OR</div>

      <div class="field">
        <label for="feature-text">Feature Description / User Story</label>
        <textarea id="feature-text"
          placeholder="Describe the feature to be tested, e.g.:&#10;'Create an incident request with auto-escalation when SLA is breached. Technician should receive an email notification, and the request status should change to Overdue.'"
          rows="6"></textarea>
      </div>

      <div class="field">
        <label for="modules-input">Module Hints (optional)</label>
        <input type="text" id="modules-input"
               placeholder="e.g. requests/request, admin/automation/notificationrules"
               list="modules-datalist" />
        <datalist id="modules-datalist"></datalist>
      </div>

      <div class="field">
        <label for="mode-select">Generation Mode</label>
        <select id="mode-select">
          <option value="new_feature">ğŸ†• New Feature â€” generate tests for a new feature</option>
          <option value="gap_fill">ğŸ” Gap Fill â€” fill coverage gaps in existing module</option>
          <option value="regression">ğŸ”„ Regression â€” regenerate/extend regression suite</option>
        </select>
      </div>

      <div id="hg-row" class="field" style="flex-direction:row;align-items:center;gap:10px;display:none;">
        <input type="checkbox" id="hg-enabled" style="width:18px;height:18px;accent-color:#007acc;cursor:pointer;">
        <label for="hg-enabled" style="cursor:pointer;font-weight:500;">
          ğŸ”€ Commit to Mercurial branch after generation
          <span style="font-size:11px;color:#777;display:block;">Creates <code>feature/AI_GEN_&lt;SLUG&gt;_BRANCH</code> in the SDPLIVE hg repo</span>
        </label>
      </div>

      <button id="btn-generate" onclick="startGeneration()">
        <div class="spinner"></div>
        <span class="btn-label">âš¡ Generate Test Cases</span>
      </button>
    </div>

    <!-- Right: live log + files -->
    <div id="right">
      <div class="run-header">
        <div class="run-title" id="run-title">Ready</div>
        <span id="status-badge" class="badge-idle">Idle</span>
      </div>

      <div id="log-panel">
        <div class="log-empty" id="log-empty">Pipeline output will appear here...</div>
      </div>

      <div id="files-panel" class="hidden">
        <div class="section-title">ğŸ“ Generated Files</div>
        <div id="files-list"></div>
      </div>
    </div>

    <!-- Bottom: run history (spans full width via JS) -->
    <div id="history">
      <div id="history-header">
        <div class="section-title" style="margin:0">ğŸ“‹ Run History</div>
        <button id="history-toggle" onclick="toggleHistory()">â–¼ Hide</button>
      </div>
      <div id="history-body">
        <table>
          <thead>
            <tr>
              <th>Run ID</th><th>Source</th><th>Mode</th><th>Status</th>
              <th>Files</th><th>Started</th><th>Duration</th>
            </tr>
          </thead>
          <tbody id="history-rows"></tbody>
        </table>
      </div>
    </div>

  </div><!-- .main-body -->
</div><!-- #app -->

<div id="toast"></div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ State â”€â”€ */
let currentRunId  = null;
let currentSource = null;   // EventSource
let selectedFile  = null;
let historyCollapsed = false;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Drag & Drop â”€â”€ */
function onDragOver(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.add('drag-over');
}
function onDragLeave(e) {
  document.getElementById('drop-zone').classList.remove('drag-over');
}
function onDrop(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) applyFile(file);
}
function onFileSelected(e) {
  const file = e.target.files[0];
  if (file) applyFile(file);
}
function applyFile(file) {
  selectedFile = file;
  const dz = document.getElementById('drop-zone');
  dz.classList.add('has-file');
  document.getElementById('dz-icon').textContent = 'âœ…';
  document.getElementById('dz-primary').textContent = 'File selected';
  document.getElementById('dz-secondary').textContent = formatBytes(file.size);
  document.getElementById('dz-filename').textContent = file.name;
  document.getElementById('clear-file').style.display = 'block';
}
function clearFile(e) {
  e.stopPropagation();
  selectedFile = null;
  document.getElementById('file-input').value = '';
  const dz = document.getElementById('drop-zone');
  dz.classList.remove('has-file');
  document.getElementById('dz-icon').textContent = 'ğŸ“‚';
  document.getElementById('dz-primary').textContent = 'Drop a document here or click to browse';
  document.getElementById('dz-secondary').textContent = 'PDF Â· DOCX Â· XLSX Â· PPTX Â· TXT Â· MD';
  document.getElementById('dz-filename').textContent = '';
  document.getElementById('clear-file').style.display = 'none';
}
function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Generation â”€â”€ */
async function startGeneration() {
  const feature = document.getElementById('feature-text').value.trim();
  const modules = document.getElementById('modules-input').value.trim();
  const mode    = document.getElementById('mode-select').value;
  const hgEnabled = document.getElementById('hg-enabled').checked;

  if (!feature && !selectedFile) {
    showToast('âš ï¸ Please enter a feature description or upload a document.', 'err');
    return;
  }

  // Close any existing stream
  if (currentSource) { currentSource.close(); currentSource = null; }

  // Build form data
  const fd = new FormData();
  fd.append('feature', feature);
  fd.append('modules', modules);
  fd.append('mode',    mode);
  fd.append('hg_enabled', hgEnabled ? 'true' : 'false');
  if (selectedFile) fd.append('file', selectedFile);

  // UI: loading state
  setButtonLoading(true);
  clearLog();
  setStatus('queued');
  const srcLabel = selectedFile ? selectedFile.name : (feature.slice(0,60) + (feature.length > 60 ? 'â€¦' : ''));
  document.getElementById('run-title').textContent = srcLabel || 'Runningâ€¦';
  document.getElementById('files-panel').classList.add('hidden');
  document.getElementById('files-list').innerHTML = '';

  try {
    const res = await fetch('/api/generate', { method: 'POST', body: fd });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || 'Server error');
    }
    const data = await res.json();
    currentRunId = data.run_id;
    startStream(currentRunId);
    loadHistory();
  } catch (err) {
    setButtonLoading(false);
    setStatus('failed');
    appendLog('âŒ ' + err.message, 'error');
    showToast('âŒ ' + err.message, 'err');
  }
}

function startStream(runId) {
  setStatus('running');
  currentSource = new EventSource(`/api/stream/${runId}`);

  currentSource.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'log') {
      appendLog(msg.data, classifyLog(msg.data));
    } else if (msg.type === 'error') {
      appendLog(msg.data, 'error');
    } else if (msg.type === 'files') {
      renderFiles(msg.data, runId);
    } else if (msg.type === 'done') {
      const ok = msg.data.status === 'success';
      const branch = msg.data.hg_branch;
      setStatus(ok ? 'success' : 'failed');
      setButtonLoading(false);
      currentSource.close(); currentSource = null;
      const branchNote = branch ? ` Â· hg: ${branch}` : '';
      showToast(ok ? `âœ… Test generation complete!${branchNote}` : 'âŒ Pipeline failed â€” check log', ok ? 'ok' : 'err');
      if (branch) appendLog(`ğŸ”€ hg branch created: ${branch}`, 'ok');
      loadHistory();
    }
    // heartbeat & __close__ â†’ ignore
  };

  currentSource.onerror = () => {
    if (currentSource && currentSource.readyState === EventSource.CLOSED) return;
    setStatus('failed');
    setButtonLoading(false);
    appendLog('âš ï¸ Stream disconnected', 'error');
    if (currentSource) { currentSource.close(); currentSource = null; }
  };
}

function classifyLog(msg) {
  if (!msg) return 'log';
  if (msg.includes('âœ…') || msg.includes('Done') || msg.includes('PASS')) return 'ok';
  if (msg.includes('âŒ') || msg.includes('Error') || msg.includes('FAIL')) return 'error';
  if (msg.includes('â„¹') || msg.includes('â†’') || msg.includes('Analyzing')) return 'info';
  return 'log';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Log panel â”€â”€ */
function appendLog(text, type='log') {
  const panel = document.getElementById('log-panel');
  // Remove empty placeholder
  const placeholder = document.getElementById('log-empty');
  if (placeholder) placeholder.remove();

  const line = document.createElement('div');
  line.className = `log-line type-${type}`;
  line.textContent = text;
  panel.appendChild(line);
  panel.scrollTop = panel.scrollHeight;
}

function clearLog() {
  const panel = document.getElementById('log-panel');
  panel.innerHTML = '<div class="log-empty" id="log-empty">Pipeline output will appear here...</div>';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Status badge â”€â”€ */
function setStatus(status) {
  const badge = document.getElementById('status-badge');
  badge.className = '';
  const map = {
    idle:    ['badge-idle',    'Idle'],
    queued:  ['badge-queued',  'Queued'],
    running: ['badge-running', 'Runningâ€¦'],
    success: ['badge-success', 'Success âœ“'],
    failed:  ['badge-failed',  'Failed âœ•'],
  };
  const [cls, label] = map[status] || map.idle;
  badge.classList.add(cls);
  badge.textContent = label;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Files panel â”€â”€ */
function renderFiles(paths, runId) {
  if (!paths || !paths.length) return;
  const panel = document.getElementById('files-panel');
  const list  = document.getElementById('files-list');
  panel.classList.remove('hidden');
  list.innerHTML = '';
  paths.forEach(p => {
    const name = p.split('/').pop();
    const chip = document.createElement('a');
    chip.className = 'file-chip';
    chip.href = `/api/runs/${runId}/file?path=${encodeURIComponent(p)}`;
    chip.target = '_blank';
    chip.innerHTML = `<span class="fi">â˜•</span>${name}`;
    list.appendChild(chip);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Btn loading â”€â”€ */
function setButtonLoading(on) {
  const btn = document.getElementById('btn-generate');
  btn.disabled = on;
  if (on) btn.classList.add('loading');
  else btn.classList.remove('loading');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ History â”€â”€ */
async function loadHistory() {
  try {
    const res = await fetch('/api/runs');
    const data = await res.json();
    const tbody = document.getElementById('history-rows');
    tbody.innerHTML = '';
    if (!data.runs.length) {
      tbody.innerHTML = '<tr><td colspan="7" style="color:var(--text-dim);text-align:center;padding:12px">No runs yet</td></tr>';
      return;
    }
    data.runs.forEach(r => {
      const tr = document.createElement('tr');
      tr.className = 'tr-click' + (r.run_id === currentRunId ? ' active-row' : '');
      const dur = r.finished_at
        ? ((new Date(r.finished_at) - new Date(r.started_at))/1000).toFixed(0) + 's'
        : (r.status === 'running' ? 'â³' : 'â€”');
      const started = new Date(r.started_at).toLocaleTimeString();
      const src = r.source_document || (r.feature ? r.feature.slice(0,40)+'â€¦' : 'â€”');
      tr.innerHTML = `
        <td><code style="font-size:11px;color:var(--blue)">${r.run_id}</code></td>
        <td title="${r.source_document || r.feature}" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${src}</td>
        <td>${r.mode}</td>
        <td><span class="st st-${r.status}">${r.status}</span></td>
        <td>${r.files_count}</td>
        <td>${started}</td>
        <td>${dur}</td>`;
      tr.onclick = () => replayRun(r.run_id);
      tbody.appendChild(tr);
    });
  } catch(e) { /* server not ready */ }
}

async function replayRun(runId) {
  currentRunId = runId;
  clearLog();
  document.getElementById('files-panel').classList.add('hidden');
  document.getElementById('files-list').innerHTML = '';

  try {
    const res = await fetch(`/api/runs/${runId}`);
    const run = await res.json();
    document.getElementById('run-title').textContent =
      run.source_document || run.feature?.slice(0,60) || runId;
    setStatus(run.status);

    run.messages.forEach(m => appendLog(m, classifyLog(m)));
    run.errors.forEach(m => appendLog(m, 'error'));
    if (run.files?.length) renderFiles(run.files, runId);
  } catch(e) {
    appendLog('Could not load run details: ' + e.message, 'error');
  }
  loadHistory();
}

function toggleHistory() {
  historyCollapsed = !historyCollapsed;
  document.getElementById('history-body').classList.toggle('collapsed', historyCollapsed);
  document.getElementById('history-toggle').textContent = historyCollapsed ? 'â–¶ Show' : 'â–¼ Hide';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Toast â”€â”€ */
let toastTimer = null;
function showToast(msg, type='ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `show toast-${type}`;
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = ''; }, 4000);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Init â”€â”€ */
async function init() {
  // Check server config â€” show hg toggle only if HG_AGENT_ENABLED=True in project_config.py
  try {
    const cfg = await fetch('/api/health').then(r => r.json());
    if (cfg.hg_agent_enabled) {
      document.getElementById('hg-row').style.display = 'flex';
    }
  } catch(e) {}
  try {
    const res = await fetch('/api/modules');
    const data = await res.json();
    const dl = document.getElementById('modules-datalist');
    (data.modules || []).forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      dl.appendChild(opt);
    });
  } catch(e) {}

  // Load history
  await loadHistory();

  // Refresh history every 5s while page is open
  setInterval(loadHistory, 5000);
}

init();
</script>
</body>
</html>
